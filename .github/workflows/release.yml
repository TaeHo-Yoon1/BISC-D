name: Build and Release

on:
  push:
    tags:
      - 'v*'  # v로 시작하는 태그가 푸시되면 실행

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write  # 릴리즈 생성을 위한 권한
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Build executable
      run: |
        # 기존 빌드 폴더 삭제
        if (Test-Path "dist") { Remove-Item -Recurse -Force "dist" }
        if (Test-Path "build") { Remove-Item -Recurse -Force "build" }
        
        # PyInstaller로 exe 파일 생성 (icon.ico가 없으면 icon 옵션 제외)
        if (Test-Path "icon.ico") {
          pyinstaller --onefile --windowed --name="DvorakTypingTrainer" --icon=icon.ico --add-data "coding_templates.json;." main.py
        } else {
          pyinstaller --onefile --windowed --name="DvorakTypingTrainer" --add-data "coding_templates.json;." main.py
        }
        
    - name: Get tag name
      id: tag
      run: echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $env:GITHUB_OUTPUT
      shell: bash
      
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: dist/DvorakTypingTrainer.exe
        name: Release ${{ steps.tag.outputs.TAG_NAME }}
        body: |
          ## 드보락 타자연습 프로그램 ${{ steps.tag.outputs.TAG_NAME }}
          
          ### 다운로드
          - **Windows**: [DvorakTypingTrainer.exe](https://github.com/${{ github.repository }}/releases/download/${{ steps.tag.outputs.TAG_NAME }}/DvorakTypingTrainer.exe)
          
          ### 설치 방법
          1. 위의 링크에서 실행 파일을 다운로드
          2. 다운로드한 파일을 더블클릭하여 실행
          
          ### 주요 기능
          - 드보락 키보드 레이아웃 표시
          - 일반 타자연습 모드
          - 코딩 연습 모드 (Python, Java, JavaScript, C++, React)
          - 실시간 통계 (WPM, 정확도, 진행률)
          - 통계 저장 및 분석
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

